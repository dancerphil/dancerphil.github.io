var e=function(exports){function t(e,t,n){if(typeof e==`function`?e===t:e.has(t))return arguments.length<3?t:n;throw TypeError(`Private element is not present on this object`)}function n(e,n,r){return e.set(t(e,n),r),r}function r(e){"@babel/helpers - typeof";return r=typeof Symbol==`function`&&typeof Symbol.iterator==`symbol`?function(e){return typeof e}:function(e){return e&&typeof Symbol==`function`&&e.constructor===Symbol&&e!==Symbol.prototype?`symbol`:typeof e},r(e)}function i(e,t){if(r(e)!=`object`||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var i=n.call(e,t||`default`);if(r(i)!=`object`)return i;throw TypeError(`@@toPrimitive must return a primitive value.`)}return(t===`string`?String:Number)(e)}function a(e){var t=i(e,`string`);return r(t)==`symbol`?t:t+``}function o(e,t,n){return(t=a(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){if(t.has(e))throw TypeError(`Cannot initialize the same private elements twice on an object`)}function c(e,t,n){s(e,t),t.set(e,n)}function l(e,t){s(e,t),t.add(e)}function u(e,n){return e.get(t(e,n))}return exports.assertClassBrand=t,exports.classPrivateFieldGet2=u,exports.classPrivateFieldInitSpec=c,exports.classPrivateFieldSet2=n,exports.classPrivateMethodInitSpec=l,exports.defineProperty=o,exports}({});import{__assign as t,__awaiter as n,__extends as r,__generator as i,createError as a,nullthrows as o}from"./utils-52664384-7e8M3Yhy.js";import{SandpackClient as s}from"./base-80a1f760-YwJopDMG.js";import{EventEmitter as c,consoleHook as l,findStartScriptPackageJson as u,fromBundlerFilesToFS as d,generateRandomId as f,getMessageFromError as p,readBuffer as m,writeBuffer as h}from"./consoleHook-59e792cb-D6Y_yWAq.js";var g=Object.create,_=Object.defineProperty,v=Object.getOwnPropertyDescriptor,y=Object.getOwnPropertyNames,ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty,ne=(e,t,n)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,b=(e,t)=>function(){return t||(0,e[y(e)[0]])((t={exports:{}}).exports,t),t.exports},x=(e,t,n,r)=>{if(t&&typeof t==`object`||typeof t==`function`)for(let i of y(t))!te.call(e,i)&&i!==n&&_(e,i,{get:()=>t[i],enumerable:!(r=v(t,i))||r.enumerable});return e},S=(e,t,n)=>(n=e==null?{}:g(ee(e)),x(t||!e||!e.__esModule?_(n,`default`,{value:e,enumerable:!0}):n,e)),re=(e,t,n)=>(ne(e,typeof t==`symbol`?t:t+``,n),n),C=(e,t,n)=>{if(!t.has(e))throw TypeError(`Cannot `+n)},w=(e,t,n)=>(C(e,t,`read from private field`),n?n.call(e):t.get(e)),T=(e,t,n)=>{if(t.has(e))throw TypeError(`Cannot add the same private member more than once`);t instanceof WeakSet?t.add(e):t.set(e,n)},E=(e,t,n,r)=>(C(e,t,`write to private field`),r?r.call(e,n):t.set(e,n),n),D=(e,t,n)=>(C(e,t,`access private method`),n),O=b({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/pad.js"(exports,t){t.exports=function(e,t){var n=`000000000`+e;return n.substr(n.length-t)}}}),ie=b({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/fingerprint.browser.js"(exports,t){var n=O(),r=typeof window==`object`?window:self,i=Object.keys(r).length,a=navigator.mimeTypes?navigator.mimeTypes.length:0,o=n((a+navigator.userAgent.length).toString(36)+i.toString(36),4);t.exports=function(){return o}}}),ae=b({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/getRandomValue.browser.js"(exports,t){var n,r=typeof window<`u`&&(window.crypto||window.msCrypto)||typeof self<`u`&&self.crypto;r?(i=2**32-1,n=function(){return Math.abs(r.getRandomValues(new Uint32Array(1))[0]/i)}):n=Math.random;var i;t.exports=n}}),k=b({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/index.js"(exports,t){var n=ie(),r=O(),i=ae(),a=0,o=4,s=36,c=s**+o;function l(){return r((i()*c<<0).toString(s),o)}function u(){return a=a<c?a:0,a++,a-1}function d(){var e=`c`,t=new Date().getTime().toString(s),i=r(u().toString(s),o),a=n(),c=l()+l();return e+t+i+a+c}d.slug=function(){var e=new Date().getTime().toString(36),t=u().toString(36).slice(-4),r=n().slice(0,1)+n().slice(-1),i=l().slice(-2);return e.slice(-2)+t+r+i},d.isCuid=function(e){return typeof e==`string`?!!e.startsWith(`c`):!1},d.isSlug=function(e){if(typeof e!=`string`)return!1;var t=e.length;return t>=7&&t<=10},d.fingerprint=n,t.exports=d}}),A=b({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/createDeferredExecutor.js"(exports){"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.createDeferredExecutor=void 0;function t(){let e=(t,n)=>{e.state=`pending`,e.resolve=n=>{if(e.state!==`pending`)return;e.result=n;let r=t=>(e.state=`fulfilled`,t);return t(n instanceof Promise?n:Promise.resolve(n).then(r))},e.reject=t=>{if(e.state===`pending`)return queueMicrotask(()=>{e.state=`rejected`}),n(e.rejectionReason=t)}};return e}exports.createDeferredExecutor=t}}),oe=b({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/DeferredPromise.js"(exports){"use strict";var n,r;Object.defineProperty(exports,`__esModule`,{value:!0}),exports.DeferredPromise=void 0;var i=A(),a=(n=new WeakMap,r=new WeakSet,class extends Promise{constructor(t=null){let a=(0,i.createDeferredExecutor)();super((e,n)=>{a(e,n),t?.(a.resolve,a.reject)}),e.classPrivateMethodInitSpec(this,r),e.classPrivateFieldInitSpec(this,n,void 0),e.defineProperty(this,`resolve`,void 0),e.defineProperty(this,`reject`,void 0),e.classPrivateFieldSet2(n,this,a),this.resolve=e.classPrivateFieldGet2(n,this).resolve,this.reject=e.classPrivateFieldGet2(n,this).reject}get state(){return e.classPrivateFieldGet2(n,this).state}get rejectionReason(){return e.classPrivateFieldGet2(n,this).rejectionReason}then(t,n){return e.assertClassBrand(r,this,o).call(this,super.then(t,n))}catch(t){return e.assertClassBrand(r,this,o).call(this,super.catch(t))}finally(t){return e.assertClassBrand(r,this,o).call(this,super.finally(t))}});function o(e){return Object.defineProperties(e,{resolve:{configurable:!0,value:this.resolve},reject:{configurable:!0,value:this.reject}})}exports.DeferredPromise=a}}),j=b({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/index.js"(exports){"use strict";var t=exports&&exports.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),n=exports&&exports.__exportStar||function(e,n){for(var r in e)r!==`default`&&!Object.prototype.hasOwnProperty.call(n,r)&&t(n,e,r)};Object.defineProperty(exports,`__esModule`,{value:!0}),n(A(),exports),n(oe(),exports)}}),M=b({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/MemoryLeakError.js"(exports){"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.MemoryLeakError=void 0;var n=class extends Error{constructor(t,n,r){super(`Possible EventEmitter memory leak detected. ${r} ${n.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),e.defineProperty(this,`emitter`,void 0),e.defineProperty(this,`type`,void 0),e.defineProperty(this,`count`,void 0),this.emitter=t,this.type=n,this.count=r,this.name=`MaxListenersExceededWarning`}};exports.MemoryLeakError=n}}),se=b({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/Emitter.js"(exports){"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.Emitter=void 0;var t=M(),n,r,i,a,o,s,c,l,u,d,f,p=class{constructor(){T(this,a),T(this,s),T(this,l),T(this,d),T(this,n,void 0),T(this,r,void 0),T(this,i,void 0),E(this,n,new Map),E(this,r,p.defaultMaxListeners),E(this,i,!1)}static listenerCount(e,t){return e.listenerCount(t)}setMaxListeners(e){return E(this,r,e),this}getMaxListeners(){return w(this,r)}eventNames(){return Array.from(w(this,n).keys())}emit(e,...t){let n=D(this,a,o).call(this,e);return n.forEach(e=>{e.apply(this,t)}),n.length>0}addListener(e,s){D(this,d,f).call(this,`newListener`,e,s);let c=D(this,a,o).call(this,e).concat(s);if(w(this,n).set(e,c),w(this,r)>0&&this.listenerCount(e)>w(this,r)&&!w(this,i)){E(this,i,!0);let n=new t.MemoryLeakError(this,e,this.listenerCount(e));console.warn(n)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,D(this,l,u).call(this,e,t))}prependListener(e,t){let r=D(this,a,o).call(this,e);if(r.length>0){let i=[t].concat(r);w(this,n).set(e,i)}else w(this,n).set(e,r.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,D(this,l,u).call(this,e,t))}removeListener(e,t){let r=D(this,a,o).call(this,e);return r.length>0&&(D(this,s,c).call(this,r,t),w(this,n).set(e,r),D(this,d,f).call(this,`removeListener`,e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?w(this,n).delete(e):w(this,n).clear(),this}listeners(e){return Array.from(D(this,a,o).call(this,e))}listenerCount(e){return D(this,a,o).call(this,e).length}rawListeners(e){return this.listeners(e)}},m=p;n=new WeakMap,r=new WeakMap,i=new WeakMap,a=new WeakSet,o=function(e){return w(this,n).get(e)||[]},s=new WeakSet,c=function(e,t){let n=e.indexOf(t);return n>-1&&e.splice(n,1),[]},l=new WeakSet,u=function(e,t){let n=(...r)=>{this.removeListener(e,n),t.apply(this,r)};return n},d=new WeakSet,f=function(e,t,n){this.emit(e,t,n)},re(m,`defaultMaxListeners`,10),exports.Emitter=m}}),N=b({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/index.js"(exports){"use strict";var t=exports&&exports.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),n=exports&&exports.__exportStar||function(e,n){for(var r in e)r!==`default`&&!Object.prototype.hasOwnProperty.call(n,r)&&t(n,e,r)};Object.defineProperty(exports,`__esModule`,{value:!0}),n(se(),exports),n(M(),exports)}}),P=S(k()),F=/(%?)(%([sdjo]))/g;function I(e,t){switch(t){case`s`:return e;case`d`:case`i`:return Number(e);case`j`:return JSON.stringify(e);case`o`:{if(typeof e==`string`)return e;let t=JSON.stringify(e);return t===`{}`||t===`[]`||/^\[object .+?\]$/.test(t)?e:t}}}function L(e,...t){if(t.length===0)return e;let n=0,r=e.replace(F,(e,r,i,a)=>{let o=t[n],s=I(o,a);return r?e:(n++,s)});return n<t.length&&(r+=` ${t.slice(n).join(` `)}`),r=r.replace(/%{2,2}/g,`%`),r}var R=2;function z(e){if(!e.stack)return;let t=e.stack.split(`
`);t.splice(1,R),e.stack=t.join(`
`)}var B=class extends Error{constructor(e,...t){super(e),this.message=e,this.name=`Invariant Violation`,this.message=L(e,...t),z(this)}},V=(e,t,...n)=>{if(!e)throw new B(t,...n)};V.as=(e,t,n,...r)=>{if(!t){let t=e.prototype.name!=null,i=t?new e(L(n,r)):e(L(n,r));throw i}};var H=S(j()),U=window.localStorage.CSB_EMULATOR_DEBUG,W=`\x1B[0m`,G=`\x1B[32;1m`,K=`\x1B[31m`,ce=`\x1B[34m`,le=`\x1B[33;1m`,ue=`\x1B[35;1m`,q=`\x1B[36;1m`,de={preview:le,emulator:ue,runtime:q,bridge:ce,"runtime:worker":q};function J(e){return function(t,...n){if(U===`true`){let r=()=>t.includes(`sender`)?`${G}sender`:t.includes(`receiver`)?`${K}receiver`:``,i=t.replace(/\[.+\]:/,``);console.debug(`${de[e]}${e}:${r()}${W}:${i}`,...n)}}}var Y=J(`emulator`),fe=class{constructor(t){e.defineProperty(this,`emitter`,void 0),e.defineProperty(this,`channel`,void 0),e.defineProperty(this,`receiverPort`,void 0),e.defineProperty(this,`receiverReadyPromise`,void 0),this.target=t,this.emitter=new EventTarget,this.channel=new MessageChannel,this.receiverPort=this.channel.port1;let n=new H.DeferredPromise,r=e=>{e.data.type===`internal/ready`&&(Y(`[message-sender]: runtime is ready`),n.resolve())};window.addEventListener(`message`,r),n.then(()=>{window.removeEventListener(`message`,r)}),this.receiverReadyPromise=n,this.receiverPort.onmessage=e=>{let t=e.data;t.type!=null&&(Y(`[message-sender]: emitting "%s" event...`,t.type,t.payload),this.emitter.dispatchEvent(new MessageEvent(t.type,{data:t.payload})))}}async handshake(){let e=new H.DeferredPromise;await this.receiverReadyPromise,Y(`[message-sender]: sending handshake`),this.target.postMessage({type:`internal/handshake`},`*`,[this.channel.port2]),this.on(`internal/handshake/done`,()=>{e.resolve(),clearTimeout(t)});let t=setTimeout(()=>{e.reject(Error(`MessageSender: Handshake timeout`))},5e3);return e}on(e,t,n){Y(`[message-sender]: add listener "%s"`,e),this.emitter.addEventListener(e,e=>{e instanceof MessageEvent&&t(e)},n)}off(e,t,n){this.emitter.removeEventListener(e,t,n)}async send(e,...t){let n=new H.DeferredPromise,r=(0,P.default)(),i=t[0]||{};Y(`[message-sender]: send "%s" (%s)`,e,r,i),this.receiverPort.postMessage({type:e,payload:{operationId:r,payload:i}}),Y(`[message-sender]: adding done listener for "%s" (%s)`,e,r);let a=t=>{let{data:i}=t;if(i.operationId===r){let t=i.listenerPayload||{};Y(`[message-sender]: resolving "%s (%s) promise!`,e,r),n.resolve({...t,operationId:i.operationId})}},o=t=>{let{data:i}=t;i.operationId===r&&(Y(`[message-sender]: rejecting "%s (%s) promise!`,e,r),n.reject(i.error))};return this.on(`internal/operation/done`,a),this.on(`internal/operation/failed`,o),n.finally(()=>{this.emitter.removeEventListener(`internal/operation/done`,a),this.emitter.removeEventListener(`internal/operation/failed`,o)})}},X=S(j()),pe=S(k()),me=class{constructor(e){this.channel=e}async init(e){await this.channel.send(`fs/init`,{files:e})}async readFile(e,t){let n=await this.channel.send(`fs/readFile`,{path:e,encoding:t}).catch(t=>{throw Error(L(`Failed to read file at path "%s"`,e),{cause:t})});if(!n)throw Error(`File not found`);return n.data}async writeFile(e,t,n){let r,i=!1;typeof n==`object`?(r=n.encoding,i=!!n.recursive):typeof n==`string`&&(r=n),await this.channel.send(`fs/writeFile`,{path:e,content:t,encoding:r,recursive:i}).catch(t=>{throw Error(L(`Failed to write file at path "%s"`,e),{cause:t})})}async readdir(e){let t=await this.channel.send(`fs/readdir`,{path:e}).catch(t=>{throw Error(L(`Failed to read directory at path "%s"`,e),{cause:t})});if(!t)throw Error(`Directory not found`);return t.data}async mkdir(e,t){let n=!!t?.recursive;await this.channel.send(`fs/mkdir`,{path:e,recursive:n}).catch(t=>{throw Error(L(`Failed to make directory at path "%s"`,e),{cause:t})})}async stat(e){let t=await this.channel.send(`fs/stat`,{path:e}).catch(t=>{throw Error(L(`Failed to stat file at path "%s"`,e),{cause:t})});if(!t)throw Error(`File not found`);return t.data}async rm(e,t){let{force:n,recursive:r}=t||{};await this.channel.send(`fs/rm`,{path:e,force:n,recursive:r}).catch(t=>{throw Error(L(`Failed to remove file at path "%s"`,e),{cause:t})})}async watch(e,t,n){let r=(0,pe.default)();return await this.channel.send(`fs/watch`,{watcherId:r,includes:e,excludes:t}),this.channel.on(`fs/watch-event`,({data:e})=>{if(e.watcherId===r&&n){let t={...e};delete t.watcherId,n(t)}}),{dispose:()=>this.channel.send(`fs/unwatch`,{watcherId:r})}}},Z=S(N()),he=class{constructor(e){this.channel=e}create(){return new ge(this.channel)}},ge=class{constructor(t){e.defineProperty(this,`id`,void 0),e.defineProperty(this,`state`,void 0),e.defineProperty(this,`stdout`,void 0),e.defineProperty(this,`stderr`,void 0),e.defineProperty(this,`stdin`,void 0),this.channel=t,this.state=`running`,this.stdout=new Z.Emitter,this.stderr=new Z.Emitter,this.stdin={write:e=>{if(!this.id)throw Error(`Failed to write to stdin, no process is currently running`);return this.channel.send(`shell/stdin`,{data:e,workerId:this.id})}},this.forwardStdEvents()}forwardStdEvents(){this.channel.on(`worker/tty`,e=>{let{data:t}=e;if(t.workerId===this.id)switch(t.payload.type){case`out`:this.stdout.emit(`data`,t.payload.data);break;case`err`:this.stderr.emit(`data`,t.payload.data);break}})}async runCommand(e,t,n={}){V(!this.id,`Failed to run "runCommand" on a ShellProcess: there is already a process running.`);let r=await this.channel.send(`shell/runCommand`,{command:e,args:t,options:n});return V(r,`Failed to run "runCommand" on a ShellProcess: was not able to retrieve a running process.`),this.id=r.id,this.state=`running`,r}async on(e,t){switch(e){case`progress`:this.channel.on(`worker/progress`,({data:e})=>{t(e.status)});return;case`exit`:this.channel.on(`worker/exit`,({data:e})=>{e.workerId===this.id&&t(e.exitCode,e.error)});return}}async kill(){V(this.id,`Failed to run "kill" on a ShellProcess: there is no process running. Did you forget to run it?`),this.state=`idle`,await this.channel.send(`shell/exit`,{id:this.id}).catch(e=>{throw Error(L(`Failed to kill shell with ID "%s"`,this.id),{cause:e})}),this.id=void 0}},_e=S(j()),ve=2e4,ye=class{constructor(e){this.channel=e}async waitFor(e,t,n=ve){let r=new _e.DeferredPromise,i=setTimeout(()=>{r.reject()},n),a=await this.channel.send(`preview/get/info`,e).catch(t=>{r.reject(Error(L(`Failed to look up preview information for shell ID "%s" (port: %d)`,e.sourceShellId,e.port)))}),o=a&&t(a);return o&&r.resolve({url:a.url,port:a.port,sourceShellId:a.sourceShellId}),this.channel.on(`preview/port/ready`,({data:e})=>{!o&&t(e)&&r.resolve({url:e.url,port:e.port,sourceShellId:e.sourceShellId})}),r.finally(()=>{clearTimeout(i)})}async getByShellId(e,t){return this.waitFor({sourceShellId:e},t=>t.sourceShellId===e,t).catch(t=>{throw Error(L(`Failed to get shell by ID "%s"`,e),{cause:t})})}async waitForPort(e,t){return this.waitFor({port:e},t=>t.port===e,t).catch(t=>{throw Error(L(`Failed to await port %d`,e),{cause:t})})}},be=`https://nodebox-runtime.codesandbox.io`,Q=J(`emulator`),$=class{constructor(t){e.defineProperty(this,`channel`,null),e.defineProperty(this,`isConnected`,void 0),e.defineProperty(this,`url`,void 0),e.defineProperty(this,`fileSystemApi`,null),e.defineProperty(this,`shellApi`,null),e.defineProperty(this,`previewApi`,null),this.options=t,V(this.options.iframe,`Failed to create a Nodebox: expected "iframe" argument to be a reference to an <iframe> element but got %j`,this.options.iframe),this.url=this.options.runtimeUrl||be,this.isConnected=!1}async connect(){let{iframe:e,cdnUrl:t}=this.options;Q(`[message-sender]: Connecting to node emulator...`);let n=new X.DeferredPromise;this.url||n.reject(Error(`Nodebox URL is missing. Did you forget to provide it when creating this Nodebox instance?`)),V(e.contentWindow,`Failed to create a MessageChannel with the Nodebox iframe: no content window found`),this.channel=new fe(e.contentWindow);let r=new X.DeferredPromise;return e.setAttribute(`src`,this.url),e.addEventListener(`load`,()=>{r.resolve()},{once:!0}),e.addEventListener(`error`,e=>{r.reject(e.error)},{once:!0}),await r,Q(`[message-sender]: IFrame loaded...`),await this.channel.handshake(),Q(`[message-sender]: Handshake completed...`),this.channel.send(`connect`,{cdnUrl:t}),this.channel.on(`runtime/ready`,()=>{n.resolve()}),n.then(()=>{Q(`[message-sender]: Connected to runtime...`),this.isConnected=!0})}get fs(){return V(this.isConnected,`Failed to access the File System API: consumer is not connected. Did you forget to run "connect()"?`),this.fileSystemApi||=new me(this.channel),this.fileSystemApi}get shell(){return V(this.isConnected,`Failed to access the Shell API: consumer is not connected. Did you forget to run "connect()"?`),this.shellApi||=new he(this.channel),this.shellApi}get preview(){return V(this.isConnected,`Failed to access the Preview API: consumer is not connected. Did you forget to run "connect()"?`),this.previewApi||=new ye(this.channel),this.previewApi}},xe=`INJECT_AND_INVOKE`,Se=`PREVIEW_LOADED`;function Ce(e,t){return n(this,void 0,void 0,function(){var n,r,s,c,l;return i(this,function(i){return n=e.contentWindow,o(n,`Failed to await preview iframe: no content window found`),r=9e4,s=20,c=0,[2,new Promise(function(n,i){var o=function(){var u=function(){clearTimeout(l),c=s,n(),e.removeEventListener(`load`,u)};if(c>=s){i(a(`Could not able to connect to preview.`));return}e.setAttribute(`src`,t),l=setTimeout(function(){o(),e.removeEventListener(`load`,u)},r),c+=1,e.addEventListener(`load`,u)};e.addEventListener(`error`,function(){return i(Error(`Iframe error`))}),e.addEventListener(`abort`,function(){return i(Error(`Aborted`))}),o()})]})})}var we=function(e,t){e.style.border=`0`,e.style.width=t.width||`100%`,e.style.height=t.height||`100%`,e.style.overflow=`hidden`,e.allow=`cross-origin-isolated`};function Te(e){var t=e.scope,n=window.history.__proto__,r=[],i=0,a=function(e){parent.postMessage({type:`urlchange`,url:e,back:i>0,forward:i<r.length-1,channelId:t.channelId},`*`)};function o(e,t){r.splice(i+1),r.push({url:e,state:t}),i=r.length-1}Object.assign(window.history,{go:function(e){var t=i+e;if(t>=0&&t<=r.length-1){i=t;var o=r[i],s=o.url,c=o.state;n.replaceState.call(window.history,c,``,s);var l=document.location.href;a(l),window.dispatchEvent(new PopStateEvent(`popstate`,{state:c}))}},back:function(){window.history.go(-1)},forward:function(){window.history.go(1)},pushState:function(e,t,r){n.replaceState.call(window.history,e,t,r),o(r,e),a(document.location.href)},replaceState:function(e,t,o){n.replaceState.call(window.history,e,t,o),r[i]={state:e,url:o},a(document.location.href)}});function s(e){var t=e.data;t.type===`urlback`?history.back():t.type===`urlforward`?history.forward():t.type===`refresh`&&document.location.reload()}window.addEventListener(`message`,s)}function Ee(e){var t=e.scope,n=0;function r(){if(typeof window>`u`)return 0;var e=document.body,t=document.documentElement;return Math.max(e.scrollHeight,e.offsetHeight,t.offsetHeight)}function i(){var e=r();n!==e&&window.parent.postMessage({type:`resize`,height:e,codesandbox:!0,channelId:t.channelId},`*`),n=e}i();var a,o=new MutationObserver(function(){a===void 0&&(i(),a=setTimeout(function(){a=void 0},300))});o.observe(document,{attributes:!0,childList:!0,subtree:!0}),setInterval(i,300)}var De=[{code:Te.toString(),id:`historyListener`},{code:`function consoleHook({ scope }) {`+l+`
};`,id:`consoleHook`},{code:Ee.toString(),id:`watchResize`}],Oe=function(e,t){De.forEach(function(n){var r,i=n.code,a=n.id,o={uid:a,type:xe,code:`exports.activate = ${i}`,scope:{channelId:t}};(r=e.contentWindow)==null||r.postMessage(o,`*`)})},ke=function(e){r(s,e);function s(n,r,i){i===void 0&&(i={});var a=e.call(this,n,r,t(t({},i),{bundlerURL:i.bundlerURL}))||this;return a._modulesCache=new Map,a.messageChannelId=f(),a._initPromise=null,a.emitter=new c,a.manageIframes(n),a.emulator=new $({iframe:a.emulatorIframe,runtimeUrl:a.options.bundlerURL}),a.updateSandbox(r),a}return s.prototype._init=function(e){return n(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return[4,this.emulator.connect()];case 1:return t.sent(),[4,this.emulator.fs.init(e)];case 2:return t.sent(),[4,this.globalListeners()];case 3:return t.sent(),[2]}})})},s.prototype.compile=function(e){return n(this,void 0,void 0,function(){var t,n;return i(this,function(r){switch(r.label){case 0:return r.trys.push([0,5,,6]),this.status=`initializing`,this.dispatch({type:`start`,firstLoad:!0}),this._initPromise||=this._init(e),[4,this._initPromise];case 1:return r.sent(),this.dispatch({type:`connected`}),[4,this.createShellProcessFromTask(e)];case 2:return t=r.sent().id,[4,this.createPreviewURLFromId(t)];case 3:return r.sent(),[4,this.setLocationURLIntoIFrame()];case 4:return r.sent(),this.dispatchDoneMessage(),[3,6];case 5:return n=r.sent(),this.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:p(n)}),this.dispatch({type:`done`,compilatonError:!0}),[3,6];case 6:return[2]}})})},s.prototype.createShellProcessFromTask=function(e){return n(this,void 0,void 0,function(){var n,r,o=this;return i(this,function(i){switch(i.label){case 0:return n=m(e[`/package.json`]),this.emulatorCommand=u(n),this.emulatorShellProcess=this.emulator.shell.create(),[4,this.emulatorShellProcess.on(`exit`,function(e){o.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:a(`Error: process.exit(${e}) called.`)})})];case 1:return i.sent(),[4,this.emulatorShellProcess.on(`progress`,function(e){var n,r;if(e.state===`command_running`||e.state===`starting_command`){o.dispatch({type:`shell/progress`,data:t(t({},e),{command:[(n=o.emulatorCommand)?.[0],(r=o.emulatorCommand)?.[1].join(` `)].join(` `)})}),o.status=`installing-dependencies`;return}o.dispatch({type:`shell/progress`,data:e})})];case 2:return i.sent(),this.emulatorShellProcess.stdout.on(`data`,function(e){o.dispatch({type:`stdout`,payload:{data:e,type:`out`}})}),this.emulatorShellProcess.stderr.on(`data`,function(e){o.dispatch({type:`stdout`,payload:{data:e,type:`err`}})}),[4,(r=this.emulatorShellProcess).runCommand.apply(r,this.emulatorCommand)];case 3:return[2,i.sent()]}})})},s.prototype.createPreviewURLFromId=function(e){var t;return n(this,void 0,void 0,function(){var n;return i(this,function(r){switch(r.label){case 0:return this.iframePreviewUrl=void 0,[4,this.emulator.preview.getByShellId(e)];case 1:return n=r.sent().url,this.iframePreviewUrl=n+((t=this.options.startRoute)??``),[2]}})})},s.prototype.manageIframes=function(e){var t;if(typeof e==`string`){var n=document.querySelector(e);o(n,`The element '${e}' was not found`),this.iframe=document.createElement(`iframe`),n?.appendChild(this.iframe)}else this.iframe=e;we(this.iframe,this.options),o(this.iframe.parentNode,`The given iframe does not have a parent.`),this.emulatorIframe=document.createElement(`iframe`),this.emulatorIframe.classList.add(`sp-bridge-frame`),(t=this.iframe.parentNode)==null||t.appendChild(this.emulatorIframe)},s.prototype.setLocationURLIntoIFrame=function(){return n(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return this.iframePreviewUrl?[4,Ce(this.iframe,this.iframePreviewUrl)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},s.prototype.dispatchDoneMessage=function(){this.status=`done`,this.dispatch({type:`done`,compilatonError:!1}),this.iframePreviewUrl&&this.dispatch({type:`urlchange`,url:this.iframePreviewUrl,back:!1,forward:!1})},s.prototype.globalListeners=function(){return n(this,void 0,void 0,function(){var e=this;return i(this,function(t){switch(t.label){case 0:return window.addEventListener(`message`,function(t){t.data.type===Se&&Oe(e.iframe,e.messageChannelId),t.data.type===`urlchange`&&t.data.channelId===e.messageChannelId?e.dispatch({type:`urlchange`,url:t.data.url,back:t.data.back,forward:t.data.forward}):t.data.channelId===e.messageChannelId&&e.dispatch(t.data)}),[4,this.emulator.fs.watch([`*`],[`.next`,`node_modules`,`build`,`dist`,`vendor`,`.config`,`.vuepress`],function(t){return n(e,void 0,void 0,function(){var e,n,r,a,o,s,c;return i(this,function(i){switch(i.label){case 0:return t?(e=t,n=`newPath`in e?e.newPath:`path`in e?e.path:``,[4,this.emulator.fs.stat(n)]):[2];case 1:if(r=i.sent().type,r!==`file`)return[2,null];i.label=2;case 2:switch(i.trys.push([2,10,,11]),a=e.type,a){case`change`:return[3,3];case`create`:return[3,3];case`remove`:return[3,5];case`rename`:return[3,6];case`close`:return[3,8]}return[3,9];case 3:return[4,this.emulator.fs.readFile(e.path,`utf8`)];case 4:return o=i.sent(),this.dispatch({type:`fs/change`,path:e.path,content:o}),this._modulesCache.set(e.path,h(o)),[3,9];case 5:return this.dispatch({type:`fs/remove`,path:e.path}),this._modulesCache.delete(e.path),[3,9];case 6:return this.dispatch({type:`fs/remove`,path:e.oldPath}),this._modulesCache.delete(e.oldPath),[4,this.emulator.fs.readFile(e.newPath,`utf8`)];case 7:return s=i.sent(),this.dispatch({type:`fs/change`,path:e.newPath,content:s}),this._modulesCache.set(e.newPath,h(s)),[3,9];case 8:return[3,9];case 9:return[3,11];case 10:return c=i.sent(),this.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:p(c)}),[3,11];case 11:return[2]}})})})];case 1:return t.sent(),[2]}})})},s.prototype.restartShellProcess=function(){var e;return n(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:return this.emulatorShellProcess&&this.emulatorCommand?(this.dispatch({type:`start`,firstLoad:!0}),this.status=`initializing`,[4,this.emulatorShellProcess.kill()]):[3,3];case 1:return t.sent(),(e=this.iframe)==null||e.removeAttribute(`attr`),this.emulator.fs.rm(`/node_modules/.vite`,{recursive:!0,force:!0}),[4,this.compile(Object.fromEntries(this._modulesCache))];case 2:t.sent(),t.label=3;case 3:return[2]}})})},s.prototype.updateSandbox=function(e){var t=this,n,r=d(e.files);if((n=this.emulatorShellProcess)?.state===`running`){Object.entries(r).forEach(function(e){var n=e[0],r=e[1];(!t._modulesCache.get(n)||m(r)!==m(t._modulesCache.get(n)))&&t.emulator.fs.writeFile(n,r,{recursive:!0})});return}this.dispatch({codesandbox:!0,modules:r,template:e.template,type:`compile`}),Object.entries(r).forEach(function(e){var n=e[0],r=e[1];t._modulesCache.set(n,h(r))})},s.prototype.dispatch=function(e){var t,r;return n(this,void 0,void 0,function(){var n;return i(this,function(i){switch(i.label){case 0:switch(n=e.type,n){case`compile`:return[3,1];case`refresh`:return[3,2];case`urlback`:return[3,4];case`urlforward`:return[3,4];case`shell/restart`:return[3,5];case`shell/openPreview`:return[3,6]}return[3,7];case 1:return this.compile(e.modules),[3,8];case 2:return[4,this.setLocationURLIntoIFrame()];case 3:return i.sent(),[3,8];case 4:return(r=(t=this.iframe)?.contentWindow)==null||r.postMessage(e,`*`),[3,8];case 5:return this.restartShellProcess(),[3,8];case 6:return window.open(this.iframePreviewUrl,`_blank`),[3,8];case 7:this.emitter.dispatch(e),i.label=8;case 8:return[2]}})})},s.prototype.listen=function(e){return this.emitter.listener(e)},s.prototype.destroy=function(){this.emulatorIframe.remove(),this.emitter.cleanup()},s}(s);export{ke as SandpackNode};