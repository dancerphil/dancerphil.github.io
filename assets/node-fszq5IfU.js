import{a as e,c as t,d as n,i as r,n as i,r as a}from"./annotate-MpO_1ZeT.js";import{t as o}from"./base-80a1f760-C7712d2v.js";import{a as s,c,i as l,n as u,o as d,r as f,s as p,t as m}from"./consoleHook-59e792cb-Dn40_nJt.js";var h=Object.create,g=Object.defineProperty,_=Object.getOwnPropertyDescriptor,v=Object.getOwnPropertyNames,ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty,ne=(e,t,n)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,y=(e,t)=>function(){return t||(0,e[v(e)[0]])((t={exports:{}}).exports,t),t.exports},b=(e,t,n,r)=>{if(t&&typeof t==`object`||typeof t==`function`)for(let i of v(t))!te.call(e,i)&&i!==n&&g(e,i,{get:()=>t[i],enumerable:!(r=_(t,i))||r.enumerable});return e},x=(e,t,n)=>(n=e==null?{}:h(ee(e)),b(t||!e||!e.__esModule?g(n,`default`,{value:e,enumerable:!0}):n,e)),re=(e,t,n)=>(ne(e,typeof t==`symbol`?t:t+``,n),n),S=(e,t,n)=>{if(!t.has(e))throw TypeError(`Cannot `+n)},C=(e,t,n)=>(S(e,t,`read from private field`),n?n.call(e):t.get(e)),w=(e,t,n)=>{if(t.has(e))throw TypeError(`Cannot add the same private member more than once`);t instanceof WeakSet?t.add(e):t.set(e,n)},T=(e,t,n,r)=>(S(e,t,`write to private field`),r?r.call(e,n):t.set(e,n),n),E=(e,t,n)=>(S(e,t,`access private method`),n),D=y({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/pad.js"(e,t){t.exports=function(e,t){var n=`000000000`+e;return n.substr(n.length-t)}}}),ie=y({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/fingerprint.browser.js"(e,t){var n=D(),r=typeof window==`object`?window:self,i=Object.keys(r).length,a=n(((navigator.mimeTypes?navigator.mimeTypes.length:0)+navigator.userAgent.length).toString(36)+i.toString(36),4);t.exports=function(){return a}}}),ae=y({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/lib/getRandomValue.browser.js"(e,t){var n,r=typeof window<`u`&&(window.crypto||window.msCrypto)||typeof self<`u`&&self.crypto;r?(i=2**32-1,n=function(){return Math.abs(r.getRandomValues(new Uint32Array(1))[0]/i)}):n=Math.random;var i;t.exports=n}}),O=y({"../../node_modules/.pnpm/cuid@2.1.8/node_modules/cuid/index.js"(e,t){var n=ie(),r=D(),i=ae(),a=0,o=4,s=36,c=s**+o;function l(){return r((i()*c<<0).toString(s),o)}function u(){return a=a<c?a:0,a++,a-1}function d(){var e=`c`,t=new Date().getTime().toString(s),i=r(u().toString(s),o),a=n(),c=l()+l();return e+t+i+a+c}d.slug=function(){var e=new Date().getTime().toString(36),t=u().toString(36).slice(-4),r=n().slice(0,1)+n().slice(-1),i=l().slice(-2);return e.slice(-2)+t+r+i},d.isCuid=function(e){return typeof e==`string`?!!e.startsWith(`c`):!1},d.isSlug=function(e){if(typeof e!=`string`)return!1;var t=e.length;return t>=7&&t<=10},d.fingerprint=n,t.exports=d}}),k=y({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/createDeferredExecutor.js"(e){Object.defineProperty(e,`__esModule`,{value:!0}),e.createDeferredExecutor=void 0;function t(){let e=(t,n)=>{e.state=`pending`,e.resolve=n=>e.state===`pending`?(e.result=n,t(n instanceof Promise?n:Promise.resolve(n).then(t=>(e.state=`fulfilled`,t)))):void 0,e.reject=t=>{if(e.state===`pending`)return queueMicrotask(()=>{e.state=`rejected`}),n(e.rejectionReason=t)}};return e}e.createDeferredExecutor=t}}),oe=y({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/DeferredPromise.js"(e){Object.defineProperty(e,`__esModule`,{value:!0}),e.DeferredPromise=void 0;var t=k();e.DeferredPromise=class extends Promise{#e;resolve;reject;constructor(e=null){let n=(0,t.createDeferredExecutor)();super((t,r)=>{n(t,r),e?.(n.resolve,n.reject)}),this.#e=n,this.resolve=this.#e.resolve,this.reject=this.#e.reject}get state(){return this.#e.state}get rejectionReason(){return this.#e.rejectionReason}then(e,t){return this.#t(super.then(e,t))}catch(e){return this.#t(super.catch(e))}finally(e){return this.#t(super.finally(e))}#t(e){return Object.defineProperties(e,{resolve:{configurable:!0,value:this.resolve},reject:{configurable:!0,value:this.reject}})}}}}),A=y({"../../node_modules/.pnpm/@open-draft+deferred-promise@2.1.0/node_modules/@open-draft/deferred-promise/build/index.js"(e){var t=e&&e.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),n=e&&e.__exportStar||function(e,n){for(var r in e)r!==`default`&&!Object.prototype.hasOwnProperty.call(n,r)&&t(n,e,r)};Object.defineProperty(e,`__esModule`,{value:!0}),n(k(),e),n(oe(),e)}}),j=y({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/MemoryLeakError.js"(e){Object.defineProperty(e,`__esModule`,{value:!0}),e.MemoryLeakError=void 0,e.MemoryLeakError=class extends Error{emitter;type;count;constructor(e,t,n){super(`Possible EventEmitter memory leak detected. ${n} ${t.toString()} listeners added. Use emitter.setMaxListeners() to increase limit`),this.emitter=e,this.type=t,this.count=n,this.name=`MaxListenersExceededWarning`}}}}),se=y({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/Emitter.js"(e){Object.defineProperty(e,`__esModule`,{value:!0}),e.Emitter=void 0;var t=j(),n,r,i,a,o,s,c,l,u,d,f,p=class{constructor(){w(this,a),w(this,s),w(this,l),w(this,d),w(this,n,void 0),w(this,r,void 0),w(this,i,void 0),T(this,n,new Map),T(this,r,p.defaultMaxListeners),T(this,i,!1)}static listenerCount(e,t){return e.listenerCount(t)}setMaxListeners(e){return T(this,r,e),this}getMaxListeners(){return C(this,r)}eventNames(){return Array.from(C(this,n).keys())}emit(e,...t){let n=E(this,a,o).call(this,e);return n.forEach(e=>{e.apply(this,t)}),n.length>0}addListener(e,s){E(this,d,f).call(this,`newListener`,e,s);let c=E(this,a,o).call(this,e).concat(s);if(C(this,n).set(e,c),C(this,r)>0&&this.listenerCount(e)>C(this,r)&&!C(this,i)){T(this,i,!0);let n=new t.MemoryLeakError(this,e,this.listenerCount(e));console.warn(n)}return this}on(e,t){return this.addListener(e,t)}once(e,t){return this.addListener(e,E(this,l,u).call(this,e,t))}prependListener(e,t){let r=E(this,a,o).call(this,e);if(r.length>0){let i=[t].concat(r);C(this,n).set(e,i)}else C(this,n).set(e,r.concat(t));return this}prependOnceListener(e,t){return this.prependListener(e,E(this,l,u).call(this,e,t))}removeListener(e,t){let r=E(this,a,o).call(this,e);return r.length>0&&(E(this,s,c).call(this,r,t),C(this,n).set(e,r),E(this,d,f).call(this,`removeListener`,e,t)),this}off(e,t){return this.removeListener(e,t)}removeAllListeners(e){return e?C(this,n).delete(e):C(this,n).clear(),this}listeners(e){return Array.from(E(this,a,o).call(this,e))}listenerCount(e){return E(this,a,o).call(this,e).length}rawListeners(e){return this.listeners(e)}},m=p;n=new WeakMap,r=new WeakMap,i=new WeakMap,a=new WeakSet,o=function(e){return C(this,n).get(e)||[]},s=new WeakSet,c=function(e,t){let n=e.indexOf(t);return n>-1&&e.splice(n,1),[]},l=new WeakSet,u=function(e,t){let n=(...r)=>{this.removeListener(e,n),t.apply(this,r)};return n},d=new WeakSet,f=function(e,t,n){this.emit(e,t,n)},re(m,`defaultMaxListeners`,10),e.Emitter=m}}),M=y({"../../node_modules/.pnpm/strict-event-emitter@0.4.3/node_modules/strict-event-emitter/lib/index.js"(e){var t=e&&e.__createBinding||(Object.create?function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]}),n=e&&e.__exportStar||function(e,n){for(var r in e)r!==`default`&&!Object.prototype.hasOwnProperty.call(n,r)&&t(n,e,r)};Object.defineProperty(e,`__esModule`,{value:!0}),n(se(),e),n(j(),e)}}),N=x(O()),P=/(%?)(%([sdjo]))/g;function F(e,t){switch(t){case`s`:return e;case`d`:case`i`:return Number(e);case`j`:return JSON.stringify(e);case`o`:{if(typeof e==`string`)return e;let t=JSON.stringify(e);return t===`{}`||t===`[]`||/^\[object .+?\]$/.test(t)?e:t}}}function I(e,...t){if(t.length===0)return e;let n=0,r=e.replace(P,(e,r,i,a)=>{let o=t[n],s=F(o,a);return r?e:(n++,s)});return n<t.length&&(r+=` ${t.slice(n).join(` `)}`),r=r.replace(/%{2,2}/g,`%`),r}var L=2;function R(e){if(!e.stack)return;let t=e.stack.split(`
`);t.splice(1,L),e.stack=t.join(`
`)}var z=class extends Error{constructor(e,...t){super(e),this.message=e,this.name=`Invariant Violation`,this.message=I(e,...t),R(this)}},B=(e,t,...n)=>{if(!e)throw new z(t,...n)};B.as=(e,t,n,...r)=>{if(!t)throw e.prototype.name==null?e(I(n,r)):new e(I(n,r))};var V=x(A()),H=window.localStorage.CSB_EMULATOR_DEBUG,U=`\x1B[0m`,W=`\x1B[32;1m`,G=`\x1B[31m`,K=`\x1B[34m`,ce=`\x1B[33;1m`,le=`\x1B[35;1m`,q=`\x1B[36;1m`,ue={preview:ce,emulator:le,runtime:q,bridge:K,"runtime:worker":q};function J(e){return function(t,...n){if(H===`true`){let r=()=>t.includes(`sender`)?`${W}sender`:t.includes(`receiver`)?`${G}receiver`:``,i=t.replace(/\[.+\]:/,``);console.debug(`${ue[e]}${e}:${r()}${U}:${i}`,...n)}}}var Y=J(`emulator`),de=class{constructor(e){this.target=e,this.emitter=new EventTarget,this.channel=new MessageChannel,this.receiverPort=this.channel.port1;let t=new V.DeferredPromise,n=e=>{e.data.type===`internal/ready`&&(Y(`[message-sender]: runtime is ready`),t.resolve())};window.addEventListener(`message`,n),t.then(()=>{window.removeEventListener(`message`,n)}),this.receiverReadyPromise=t,this.receiverPort.onmessage=e=>{let t=e.data;t.type!=null&&(Y(`[message-sender]: emitting "%s" event...`,t.type,t.payload),this.emitter.dispatchEvent(new MessageEvent(t.type,{data:t.payload})))}}emitter;channel;receiverPort;receiverReadyPromise;async handshake(){let e=new V.DeferredPromise;await this.receiverReadyPromise,Y(`[message-sender]: sending handshake`),this.target.postMessage({type:`internal/handshake`},`*`,[this.channel.port2]),this.on(`internal/handshake/done`,()=>{e.resolve(),clearTimeout(t)});let t=setTimeout(()=>{e.reject(Error(`MessageSender: Handshake timeout`))},5e3);return e}on(e,t,n){Y(`[message-sender]: add listener "%s"`,e),this.emitter.addEventListener(e,e=>{e instanceof MessageEvent&&t(e)},n)}off(e,t,n){this.emitter.removeEventListener(e,t,n)}async send(e,...t){let n=new V.DeferredPromise,r=(0,N.default)(),i=t[0]||{};Y(`[message-sender]: send "%s" (%s)`,e,r,i),this.receiverPort.postMessage({type:e,payload:{operationId:r,payload:i}}),Y(`[message-sender]: adding done listener for "%s" (%s)`,e,r);let a=t=>{let{data:i}=t;if(i.operationId===r){let t=i.listenerPayload||{};Y(`[message-sender]: resolving "%s (%s) promise!`,e,r),n.resolve({...t,operationId:i.operationId})}},o=t=>{let{data:i}=t;i.operationId===r&&(Y(`[message-sender]: rejecting "%s (%s) promise!`,e,r),n.reject(i.error))};return this.on(`internal/operation/done`,a),this.on(`internal/operation/failed`,o),n.finally(()=>{this.emitter.removeEventListener(`internal/operation/done`,a),this.emitter.removeEventListener(`internal/operation/failed`,o)})}},X=x(A()),fe=x(O()),pe=class{constructor(e){this.channel=e}async init(e){await this.channel.send(`fs/init`,{files:e})}async readFile(e,t){let n=await this.channel.send(`fs/readFile`,{path:e,encoding:t}).catch(t=>{throw Error(I(`Failed to read file at path "%s"`,e),{cause:t})});if(!n)throw Error(`File not found`);return n.data}async writeFile(e,t,n){let r,i=!1;typeof n==`object`?(r=n.encoding,i=!!n.recursive):typeof n==`string`&&(r=n),await this.channel.send(`fs/writeFile`,{path:e,content:t,encoding:r,recursive:i}).catch(t=>{throw Error(I(`Failed to write file at path "%s"`,e),{cause:t})})}async readdir(e){let t=await this.channel.send(`fs/readdir`,{path:e}).catch(t=>{throw Error(I(`Failed to read directory at path "%s"`,e),{cause:t})});if(!t)throw Error(`Directory not found`);return t.data}async mkdir(e,t){let n=!!t?.recursive;await this.channel.send(`fs/mkdir`,{path:e,recursive:n}).catch(t=>{throw Error(I(`Failed to make directory at path "%s"`,e),{cause:t})})}async stat(e){let t=await this.channel.send(`fs/stat`,{path:e}).catch(t=>{throw Error(I(`Failed to stat file at path "%s"`,e),{cause:t})});if(!t)throw Error(`File not found`);return t.data}async rm(e,t){let{force:n,recursive:r}=t||{};await this.channel.send(`fs/rm`,{path:e,force:n,recursive:r}).catch(t=>{throw Error(I(`Failed to remove file at path "%s"`,e),{cause:t})})}async watch(e,t,n){let r=(0,fe.default)();return await this.channel.send(`fs/watch`,{watcherId:r,includes:e,excludes:t}),this.channel.on(`fs/watch-event`,({data:e})=>{if(e.watcherId===r&&n){let t={...e};delete t.watcherId,n(t)}}),{dispose:()=>this.channel.send(`fs/unwatch`,{watcherId:r})}}},Z=x(M()),me=class{constructor(e){this.channel=e}create(){return new he(this.channel)}},he=class{constructor(e){this.channel=e,this.state=`running`,this.stdout=new Z.Emitter,this.stderr=new Z.Emitter,this.stdin={write:e=>{if(!this.id)throw Error(`Failed to write to stdin, no process is currently running`);return this.channel.send(`shell/stdin`,{data:e,workerId:this.id})}},this.forwardStdEvents()}id;state;stdout;stderr;stdin;forwardStdEvents(){this.channel.on(`worker/tty`,e=>{let{data:t}=e;if(t.workerId===this.id)switch(t.payload.type){case`out`:this.stdout.emit(`data`,t.payload.data);break;case`err`:this.stderr.emit(`data`,t.payload.data);break}})}async runCommand(e,t,n={}){B(!this.id,`Failed to run "runCommand" on a ShellProcess: there is already a process running.`);let r=await this.channel.send(`shell/runCommand`,{command:e,args:t,options:n});return B(r,`Failed to run "runCommand" on a ShellProcess: was not able to retrieve a running process.`),this.id=r.id,this.state=`running`,r}async on(e,t){switch(e){case`progress`:this.channel.on(`worker/progress`,({data:e})=>{t(e.status)});return;case`exit`:this.channel.on(`worker/exit`,({data:e})=>{e.workerId===this.id&&t(e.exitCode,e.error)});return}}async kill(){B(this.id,`Failed to run "kill" on a ShellProcess: there is no process running. Did you forget to run it?`),this.state=`idle`,await this.channel.send(`shell/exit`,{id:this.id}).catch(e=>{throw Error(I(`Failed to kill shell with ID "%s"`,this.id),{cause:e})}),this.id=void 0}},ge=x(A()),_e=2e4,ve=class{constructor(e){this.channel=e}async waitFor(e,t,n=_e){let r=new ge.DeferredPromise,i=setTimeout(()=>{r.reject()},n),a=await this.channel.send(`preview/get/info`,e).catch(t=>{r.reject(Error(I(`Failed to look up preview information for shell ID "%s" (port: %d)`,e.sourceShellId,e.port)))}),o=a&&t(a);return o&&r.resolve({url:a.url,port:a.port,sourceShellId:a.sourceShellId}),this.channel.on(`preview/port/ready`,({data:e})=>{!o&&t(e)&&r.resolve({url:e.url,port:e.port,sourceShellId:e.sourceShellId})}),r.finally(()=>{clearTimeout(i)})}async getByShellId(e,t){return this.waitFor({sourceShellId:e},t=>t.sourceShellId===e,t).catch(t=>{throw Error(I(`Failed to get shell by ID "%s"`,e),{cause:t})})}async waitForPort(e,t){return this.waitFor({port:e},t=>t.port===e,t).catch(t=>{throw Error(I(`Failed to await port %d`,e),{cause:t})})}},ye=`https://nodebox-runtime.codesandbox.io`,Q=J(`emulator`),be=class{constructor(e){this.options=e,B(this.options.iframe,`Failed to create a Nodebox: expected "iframe" argument to be a reference to an <iframe> element but got %j`,this.options.iframe),this.url=this.options.runtimeUrl||ye,this.isConnected=!1}channel=null;isConnected;url;fileSystemApi=null;shellApi=null;previewApi=null;async connect(){let{iframe:e,cdnUrl:t}=this.options;Q(`[message-sender]: Connecting to node emulator...`);let n=new X.DeferredPromise;this.url||n.reject(Error(`Nodebox URL is missing. Did you forget to provide it when creating this Nodebox instance?`)),B(e.contentWindow,`Failed to create a MessageChannel with the Nodebox iframe: no content window found`),this.channel=new de(e.contentWindow);let r=new X.DeferredPromise;return e.setAttribute(`src`,this.url),e.addEventListener(`load`,()=>{r.resolve()},{once:!0}),e.addEventListener(`error`,e=>{r.reject(e.error)},{once:!0}),await r,Q(`[message-sender]: IFrame loaded...`),await this.channel.handshake(),Q(`[message-sender]: Handshake completed...`),this.channel.send(`connect`,{cdnUrl:t}),this.channel.on(`runtime/ready`,()=>{n.resolve()}),n.then(()=>{Q(`[message-sender]: Connected to runtime...`),this.isConnected=!0})}get fs(){return B(this.isConnected,`Failed to access the File System API: consumer is not connected. Did you forget to run "connect()"?`),this.fileSystemApi||=new pe(this.channel),this.fileSystemApi}get shell(){return B(this.isConnected,`Failed to access the Shell API: consumer is not connected. Did you forget to run "connect()"?`),this.shellApi||=new me(this.channel),this.shellApi}get preview(){return B(this.isConnected,`Failed to access the Preview API: consumer is not connected. Did you forget to run "connect()"?`),this.previewApi||=new ve(this.channel),this.previewApi}},$=`INJECT_AND_INVOKE`;function xe(r,i){return a(this,void 0,void 0,function(){var a,o,s,c,l;return e(this,function(e){return a=r.contentWindow,n(a,`Failed to await preview iframe: no content window found`),o=9e4,s=20,c=0,[2,new Promise(function(e,n){var a=function(){var u=function(){clearTimeout(l),c=s,e(),r.removeEventListener(`load`,u)};if(c>=s){n(t(`Could not able to connect to preview.`));return}r.setAttribute(`src`,i),l=setTimeout(function(){a(),r.removeEventListener(`load`,u)},o),c+=1,r.addEventListener(`load`,u)};r.addEventListener(`error`,function(){return n(Error(`Iframe error`))}),r.addEventListener(`abort`,function(){return n(Error(`Aborted`))}),a()})]})})}var Se=function(e,t){e.style.border=`0`,e.style.width=t.width||`100%`,e.style.height=t.height||`100%`,e.style.overflow=`hidden`,e.allow=`cross-origin-isolated`};function Ce(e){var t=e.scope,n=window.history.__proto__,r=[],i=0,a=function(e){parent.postMessage({type:`urlchange`,url:e,back:i>0,forward:i<r.length-1,channelId:t.channelId},`*`)};function o(e,t){r.splice(i+1),r.push({url:e,state:t}),i=r.length-1}Object.assign(window.history,{go:function(e){var t=i+e;if(t>=0&&t<=r.length-1){i=t;var o=r[i],s=o.url,c=o.state;n.replaceState.call(window.history,c,``,s);var l=document.location.href;a(l),window.dispatchEvent(new PopStateEvent(`popstate`,{state:c}))}},back:function(){window.history.go(-1)},forward:function(){window.history.go(1)},pushState:function(e,t,r){n.replaceState.call(window.history,e,t,r),o(r,e),a(document.location.href)},replaceState:function(e,t,o){n.replaceState.call(window.history,e,t,o),r[i]={state:e,url:o},a(document.location.href)}});function s(e){var t=e.data;t.type===`urlback`?history.back():t.type===`urlforward`?history.forward():t.type===`refresh`&&document.location.reload()}window.addEventListener(`message`,s)}function we(e){var t=e.scope,n=0;function r(){if(typeof window>`u`)return 0;var e=document.body,t=document.documentElement;return Math.max(e.scrollHeight,e.offsetHeight,t.offsetHeight)}function i(){var e=r();n!==e&&window.parent.postMessage({type:`resize`,height:e,codesandbox:!0,channelId:t.channelId},`*`),n=e}i();var a;new MutationObserver(function(){a===void 0&&(i(),a=setTimeout(function(){a=void 0},300))}).observe(document,{attributes:!0,childList:!0,subtree:!0}),setInterval(i,300)}var Te=[{code:Ce.toString(),id:`historyListener`},{code:`function consoleHook({ scope }) {`+u+`
};`,id:`consoleHook`},{code:we.toString(),id:`watchResize`}],Ee=function(e,t){Te.forEach(function(n){var r,i=n.code,a={uid:n.id,type:$,code:`exports.activate = ${i}`,scope:{channelId:t}};(r=e.contentWindow)==null||r.postMessage(a,`*`)})},De=function(o){r(u,o);function u(e,t,n){n===void 0&&(n={});var r=o.call(this,e,t,i(i({},n),{bundlerURL:n.bundlerURL}))||this;return r._modulesCache=new Map,r.messageChannelId=s(),r._initPromise=null,r.emitter=new m,r.manageIframes(e),r.emulator=new be({iframe:r.emulatorIframe,runtimeUrl:r.options.bundlerURL}),r.updateSandbox(t),r}return u.prototype._init=function(t){return a(this,void 0,void 0,function(){return e(this,function(e){switch(e.label){case 0:return[4,this.emulator.connect()];case 1:return e.sent(),[4,this.emulator.fs.init(t)];case 2:return e.sent(),[4,this.globalListeners()];case 3:return e.sent(),[2]}})})},u.prototype.compile=function(t){return a(this,void 0,void 0,function(){var n,r;return e(this,function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),this.status=`initializing`,this.dispatch({type:`start`,firstLoad:!0}),this._initPromise||=this._init(t),[4,this._initPromise];case 1:return e.sent(),this.dispatch({type:`connected`}),[4,this.createShellProcessFromTask(t)];case 2:return n=e.sent().id,[4,this.createPreviewURLFromId(n)];case 3:return e.sent(),[4,this.setLocationURLIntoIFrame()];case 4:return e.sent(),this.dispatchDoneMessage(),[3,6];case 5:return r=e.sent(),this.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:d(r)}),this.dispatch({type:`done`,compilatonError:!0}),[3,6];case 6:return[2]}})})},u.prototype.createShellProcessFromTask=function(n){return a(this,void 0,void 0,function(){var r,a,o=this;return e(this,function(e){switch(e.label){case 0:return r=p(n[`/package.json`]),this.emulatorCommand=f(r),this.emulatorShellProcess=this.emulator.shell.create(),[4,this.emulatorShellProcess.on(`exit`,function(e){o.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:t(`Error: process.exit(${e}) called.`)})})];case 1:return e.sent(),[4,this.emulatorShellProcess.on(`progress`,function(e){if(e.state===`command_running`||e.state===`starting_command`){o.dispatch({type:`shell/progress`,data:i(i({},e),{command:[o.emulatorCommand?.[0],o.emulatorCommand?.[1].join(` `)].join(` `)})}),o.status=`installing-dependencies`;return}o.dispatch({type:`shell/progress`,data:e})})];case 2:return e.sent(),this.emulatorShellProcess.stdout.on(`data`,function(e){o.dispatch({type:`stdout`,payload:{data:e,type:`out`}})}),this.emulatorShellProcess.stderr.on(`data`,function(e){o.dispatch({type:`stdout`,payload:{data:e,type:`err`}})}),[4,(a=this.emulatorShellProcess).runCommand.apply(a,this.emulatorCommand)];case 3:return[2,e.sent()]}})})},u.prototype.createPreviewURLFromId=function(t){return a(this,void 0,void 0,function(){var n;return e(this,function(e){switch(e.label){case 0:return this.iframePreviewUrl=void 0,[4,this.emulator.preview.getByShellId(t)];case 1:return n=e.sent().url,this.iframePreviewUrl=n+(this.options.startRoute??``),[2]}})})},u.prototype.manageIframes=function(e){var t;if(typeof e==`string`){var r=document.querySelector(e);n(r,`The element '${e}' was not found`),this.iframe=document.createElement(`iframe`),r?.appendChild(this.iframe)}else this.iframe=e;Se(this.iframe,this.options),n(this.iframe.parentNode,`The given iframe does not have a parent.`),this.emulatorIframe=document.createElement(`iframe`),this.emulatorIframe.classList.add(`sp-bridge-frame`),(t=this.iframe.parentNode)==null||t.appendChild(this.emulatorIframe)},u.prototype.setLocationURLIntoIFrame=function(){return a(this,void 0,void 0,function(){return e(this,function(e){switch(e.label){case 0:return this.iframePreviewUrl?[4,xe(this.iframe,this.iframePreviewUrl)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},u.prototype.dispatchDoneMessage=function(){this.status=`done`,this.dispatch({type:`done`,compilatonError:!1}),this.iframePreviewUrl&&this.dispatch({type:`urlchange`,url:this.iframePreviewUrl,back:!1,forward:!1})},u.prototype.globalListeners=function(){return a(this,void 0,void 0,function(){var t=this;return e(this,function(n){switch(n.label){case 0:return window.addEventListener(`message`,function(e){e.data.type===`PREVIEW_LOADED`&&Ee(t.iframe,t.messageChannelId),e.data.type===`urlchange`&&e.data.channelId===t.messageChannelId?t.dispatch({type:`urlchange`,url:e.data.url,back:e.data.back,forward:e.data.forward}):e.data.channelId===t.messageChannelId&&t.dispatch(e.data)}),[4,this.emulator.fs.watch([`*`],[`.next`,`node_modules`,`build`,`dist`,`vendor`,`.config`,`.vuepress`],function(n){return a(t,void 0,void 0,function(){var t,r,i,a,o,s,l;return e(this,function(e){switch(e.label){case 0:return n?(t=n,r=`newPath`in t?t.newPath:`path`in t?t.path:``,[4,this.emulator.fs.stat(r)]):[2];case 1:if(i=e.sent().type,i!==`file`)return[2,null];e.label=2;case 2:switch(e.trys.push([2,10,,11]),a=t.type,a){case`change`:return[3,3];case`create`:return[3,3];case`remove`:return[3,5];case`rename`:return[3,6];case`close`:return[3,8]}return[3,9];case 3:return[4,this.emulator.fs.readFile(t.path,`utf8`)];case 4:return o=e.sent(),this.dispatch({type:`fs/change`,path:t.path,content:o}),this._modulesCache.set(t.path,c(o)),[3,9];case 5:return this.dispatch({type:`fs/remove`,path:t.path}),this._modulesCache.delete(t.path),[3,9];case 6:return this.dispatch({type:`fs/remove`,path:t.oldPath}),this._modulesCache.delete(t.oldPath),[4,this.emulator.fs.readFile(t.newPath,`utf8`)];case 7:return s=e.sent(),this.dispatch({type:`fs/change`,path:t.newPath,content:s}),this._modulesCache.set(t.newPath,c(s)),[3,9];case 8:return[3,9];case 9:return[3,11];case 10:return l=e.sent(),this.dispatch({type:`action`,action:`notification`,notificationType:`error`,title:d(l)}),[3,11];case 11:return[2]}})})})];case 1:return n.sent(),[2]}})})},u.prototype.restartShellProcess=function(){var t;return a(this,void 0,void 0,function(){return e(this,function(e){switch(e.label){case 0:return this.emulatorShellProcess&&this.emulatorCommand?(this.dispatch({type:`start`,firstLoad:!0}),this.status=`initializing`,[4,this.emulatorShellProcess.kill()]):[3,3];case 1:return e.sent(),(t=this.iframe)==null||t.removeAttribute(`attr`),this.emulator.fs.rm(`/node_modules/.vite`,{recursive:!0,force:!0}),[4,this.compile(Object.fromEntries(this._modulesCache))];case 2:e.sent(),e.label=3;case 3:return[2]}})})},u.prototype.updateSandbox=function(e){var t=this,n=l(e.files);if(this.emulatorShellProcess?.state===`running`){Object.entries(n).forEach(function(e){var n=e[0],r=e[1];(!t._modulesCache.get(n)||p(r)!==p(t._modulesCache.get(n)))&&t.emulator.fs.writeFile(n,r,{recursive:!0})});return}this.dispatch({codesandbox:!0,modules:n,template:e.template,type:`compile`}),Object.entries(n).forEach(function(e){var n=e[0],r=e[1];t._modulesCache.set(n,c(r))})},u.prototype.dispatch=function(t){var n;return a(this,void 0,void 0,function(){var r;return e(this,function(e){switch(e.label){case 0:switch(r=t.type,r){case`compile`:return[3,1];case`refresh`:return[3,2];case`urlback`:return[3,4];case`urlforward`:return[3,4];case`shell/restart`:return[3,5];case`shell/openPreview`:return[3,6]}return[3,7];case 1:return this.compile(t.modules),[3,8];case 2:return[4,this.setLocationURLIntoIFrame()];case 3:return e.sent(),[3,8];case 4:return(n=this.iframe?.contentWindow)==null||n.postMessage(t,`*`),[3,8];case 5:return this.restartShellProcess(),[3,8];case 6:return window.open(this.iframePreviewUrl,`_blank`),[3,8];case 7:this.emitter.dispatch(t),e.label=8;case 8:return[2]}})})},u.prototype.listen=function(e){return this.emitter.listener(e)},u.prototype.destroy=function(){this.emulatorIframe.remove(),this.emitter.cleanup()},u}(o);export{De as SandpackNode};